<%# app/views/sections/index.html.erb %>

<p style="color: green"><%= notice %></p>

<h3>Aisle <%= @aisle.aisle_num %></h3>      

<%= form_with url: plan_aisle_sections_path(@aisle), method: :post, local: true do %>
<div class="row">
   <fieldset>
    <legend>Select Planning Mode</legend>
    <% ['non_opul', 'opul', 'countertop', 'voss', 'pallet'].each do |mode| %>
      <label>
        <%= radio_button_tag :mode, "#{mode}_mode",
          (params[:mode] == "#{mode}_mode" || (params[:mode].blank? && mode == 'non_opul')),
          id: "mode_#{mode}" %>
        <%= mode.humanize %>
      </label>
    <% end %>
  </fieldset>

  <fieldset>
    <label for="name_prefix">Name starts with (optional)</label>
    <%= text_field_tag :name_prefix, params[:name_prefix], placeholder: "e.g., SE" %>
  </fieldset>

  <fieldset>
    <legend>Filter Articles By</legend>
    <label>
      <%= radio_button_tag :filter_type, "PA", params[:filter_type].blank? || params[:filter_type] == "PA" %> PA
    </label>
    <label>
      <%= radio_button_tag :filter_type, "HFB", params[:filter_type] == "HFB" %> HFB
    </label>
    <%= text_field_tag :filter_value, params[:filter_value], placeholder: "Enter PA or HFB value" %>
  </fieldset>

  <fieldset>
    <legend>Extra Filters</legend>
    <label>
      <%= check_box_tag :low_expsale_only, '1', params[:low_expsale_only].present? %>
      Only plan articles where <code>EXPSALE &lt; 5</code>
    </label><br>

    <label>
      <%= check_box_tag :high_expsale_only, '1', params[:high_expsale_only].present?, id: 'high_expsale_only' %>
      Only plan articles where <code>EXPSALE &gt; 5</code>
    </label>

    <div id="high-expsale-subfilters"
         style="margin-top:6px; display:<%= params[:high_expsale_only].present? ? 'block' : 'none' %>;">
      <label style="display:inline-flex; gap:6px; align-items:center;">
        <%= check_box_tag :high_expsale_require_dt1, '1', params[:high_expsale_require_dt1].present? %>
        Also require <code>DT = 1</code>
      </label>
    </div>
  </fieldset>

  <% is_voss   = params[:mode] == 'voss_mode' %>
  <% is_pallet = params[:mode] == 'pallet_mode' %>

  <fieldset id="voss-filters" style="display:<%= is_voss ? 'block' : 'none' %>;">
    <legend>VOSS Gates (optional)</legend>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <label>Max CP_HEIGHT (mm)
        <%= number_field_tag :voss_cp_height_max, params[:voss_cp_height_max] || 508, step: 0.01 %>
      </label>
      <label>Max CP_LENGTH (mm)
        <%= number_field_tag :voss_cp_length_max, params[:voss_cp_length_max] || 1016, step: 0.01 %>
      </label>
      <label>Max CP_WIDTH (mm)
        <%= number_field_tag :voss_cp_width_max, params[:voss_cp_width_max] || 1016, step: 0.01 %>
      </label>
      <label>Max RSSQ
        <%= number_field_tag :voss_rssq_max, params[:voss_rssq_max] || 10, step: 1 %>
      </label>
      <label>Max EXPSALE
        <%= number_field_tag :voss_expsale_max, params[:voss_expsale_max] || 5.0, step: 0.01 %>
      </label>
      <label>Max WEIGHT_G (g)
        <%= number_field_tag :voss_weight_g_max, params[:voss_weight_g_max] || 4536, step: 1 %>
      </label>
    </div>
  </fieldset>

 <fieldset id="pallet-filters" style="display:<%= is_pallet ? 'block' : 'none' %>;">
  <legend>PALLET Gates (optional)</legend>

  <div style="display:flex; gap:10px; flex-wrap:wrap">
    <label>Max UL_HEIGHT (mm)
      <%= number_field_tag :voss_ul_height_max, params[:voss_ul_height_max], step: 0.01 %>
    </label>

    <label>Max UL_LENGTH (mm)
      <%= number_field_tag :voss_ul_length_max, params[:voss_ul_length_max], step: 0.01 %>
    </label>

    <label>Max UL_WIDTH (mm)
      <%= number_field_tag :voss_ul_width_max, params[:voss_ul_width_max], step: 0.01 %>
    </label>

    <label>Max RSSQ
      <%= number_field_tag :voss_rssq_max, params[:voss_rssq_max] || 10, step: 1 %>
    </label>

    <label>Max EXPSALE
      <%= number_field_tag :voss_expsale_max, params[:voss_expsale_max] || 5.0, step: 0.01 %>
    </label>

    <label>Max WEIGHT_G (g)
      <%= number_field_tag :voss_weight_g_max, params[:voss_weight_g_max] || 4536, step: 1 %>
    </label>
  </div>
</fieldset>
</div>

<%= submit_tag "Run Bin Planner" %>
<% end %>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const vossRadio   = document.getElementById("mode_voss");
    const palletRadio = document.getElementById("mode_pallet");

    const vossFilters   = document.getElementById("voss-filters");
    const palletFilters = document.getElementById("pallet-filters");

    const modeRadios = document.querySelectorAll("input[name='mode']");

    function toggleFilters() {
      if (vossFilters)
        vossFilters.style.display = vossRadio?.checked ? "block" : "none";

      if (palletFilters)
        palletFilters.style.display = palletRadio?.checked ? "block" : "none";
    }

    modeRadios.forEach(radio => {
      radio.addEventListener("change", toggleFilters);
    });

    toggleFilters();
  });
</script>

<hr>

<h1>Sections</h1>

<div style="margin-bottom: 20px;">
  <%= button_to "UNASSIGN ALL ARTICLES IN AISLE #{@aisle.aisle_num}", 
      bulk_unassign_aisle_path(@aisle), 
      method: :patch,
      data: { confirm: 'WARNING! This will unassign ALL planned articles in this aisle. Are you sure?' },
      style: "background-color:#d9534f;color:white;padding:8px 15px;border:none;border-radius:4px;" %>
</div>

<% @sections.sort_by{ |sec| sec.section_num}.each do |section| %>
  <div class="card col-12" style="border:1px solid #ccc; padding:12px; margin-bottom:16px;">
    <h3>Section <%= link_to section.section_num, section %></h3>

    <p>
      <strong>Section Height:</strong> <%= section.section_height %> mm<br>
      <strong>Used Height:</strong>
      <%= section.levels.sum { |l| l.level_height.to_f }.round(1) %> mm<br>
      <strong>Section Width:</strong> <%= section.section_width %> mm<br>
      <strong>Section Depth:</strong> <%= section.section_depth %> mm
    </p>

    <% section.levels.order(:level_num).each do |level| %>
      <div style="border:1px dashed #999; padding:10px; margin-bottom:10px;">
        <h4>
          Level <%= level.level_num %>
          <span style="color:#555;font-size:0.9em">
            (Height: <%= level.level_height.round(2) %> mm)
          </span>
        </h4>

        <% articles = section.articles.where(level_id: level.id, planned: true) %>

        <% if articles.any? %>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f4f4f4">
                <th>Art No</th>
                <th>Name</th>
                <th>DT</th>
                <th>Weight</th>
                <th>Width Used</th>
                <th>Height</th>
                <th>PA</th>
                <th>RSSQ</th>
                <th>PALQ</th>
                <th>Badges</th>
                <th>Current Loc</th>
                <th>Unassign</th>
              </tr>
            </thead>

            <tbody>
              <% articles.each do |art| %>
                <% qualifies_for_mb = art.rssq.to_f > art.palq.to_f * 1.50 %>

                <tr style="border-top:1px solid #ddd">
                  <td><%= link_to art.artno, art %></td>
                  <td><%= art.artname_unicode %></td>
                  <td align="center"><%= art.dt %></td>
                  <td align="right"><%= art.weight_g %></td>

                 <td align="right">
                  <% if art.plan_badge&.include?('M') && qualifies_for_mb %>
                    <%= (art.ul_width_gross.to_f * 2).round(1) %>
                  <% elsif art.plan_badge&.include?('O') %>
                    <%= art.ul_width_gross %>
                  <% elsif art.level.level_num == "00" %>
                    <%= art.ul_width_gross %>
                  <% else %>
                    <%= art.cp_width %>
                  <% end %>
                </td>

                  <td align="right"><%= art.effective_height.round(2) %></td>
                  <td><%= art.pa %></td>
                  <td><%= art.rssq %></td>
                  <td><%= art.palq %></td>

                  <td align="center">
                    <% if art.plan_badge.present? %>
                      <% art.plan_badge.each_char do |badge| %>
                        <% next if ['M','B'].include?(badge) && !qualifies_for_mb && badge != 'O' %>
                        <span
                          style="
                            padding:2px 6px;
                            border-radius:4px;
                            font-weight:bold;
                            color:white;
                            margin-right:3px;
                            background:
                              <%= case badge
                                  when 'M' then '#d9534f'
                                  when 'B' then '#0275d8'
                                  when 'O' then '#6f42c1'
                                  else '#999'
                                end %>;
                          ">
                          <%= badge %>
                        </span>
                      <% end %>
                    <% end %>
                  </td>

                  <td><%= art.slid_h %></td>

                  <td align="center">
                    <%= button_to "Unassign",
                          unassign_article_path(art),
                          method: :patch,
                          data: { confirm: "Unassign article #{art.artno}?" },
                          style: "background-color:#f0ad4e;color:white;padding:4px 8px;border:none;border-radius:4px;" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p style="color:#777">No articles on this level</p>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<%= link_to "New section", new_aisle_section_path(@aisle) %>
