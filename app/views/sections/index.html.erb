<%# app/views/sections/index.html.erb %>

<p style="color: green"><%= notice %></p>

<h3>Aisle <%= link_to  @aisle.aisle_num, @aisle %></h3>      

<%= form_with url: plan_aisle_sections_path(@aisle), method: :post, local: true do %>
<div class="row">
   <fieldset>
    <legend>Select Planning Mode</legend>
    <% ['non_opul', 'opul', 'countertop', 'voss', 'pallet'].each do |mode| %>
      <label>
        <%= radio_button_tag :mode, "#{mode}_mode",
          (params[:mode] == "#{mode}_mode" || (params[:mode].blank? && mode == 'non_opul')),
          id: "mode_#{mode}" %>
        <%= mode.humanize %>
      </label>
    <% end %>
  </fieldset>

  <fieldset>
    <label for="name_prefix">Name starts with (optional)</label>
    <%= text_field_tag :name_prefix, params[:name_prefix], placeholder: "e.g., SE" %>
  </fieldset>

  <fieldset>
    <legend>Filter Articles By</legend>
    <label>
      <%= radio_button_tag :filter_type, "PA", params[:filter_type].blank? || params[:filter_type] == "PA" %> PA
    </label>
    <label>
      <%= radio_button_tag :filter_type, "HFB", params[:filter_type] == "HFB" %> HFB
    </label>
    <%= text_field_tag :filter_value, params[:filter_value], placeholder: "Enter PA or HFB value" %>
  </fieldset>

  <fieldset>
    <legend>Extra Filters</legend>
    <label>
      <%= check_box_tag :low_expsale_only, '1', params[:low_expsale_only].present? %>
      Only plan articles where <code>EXPSALE &lt; 5</code>
    </label><br>

    <label>
      <%= check_box_tag :high_expsale_only, '1', params[:high_expsale_only].present?, id: 'high_expsale_only' %>
      Only plan articles where <code>EXPSALE &gt; 5</code>
    </label>

    <div id="high-expsale-subfilters"
          style="margin-top:6px; display:<%= params[:high_expsale_only].present? ? 'block' : 'none' %>;">
      <label style="display:inline-flex; gap:6px; align-items:center;">
        <%= check_box_tag :high_expsale_require_dt1, '1', params[:high_expsale_require_dt1].present? %>
        Also require <code>DT = 1</code>
      </label>
    </div>
  </fieldset>
</div>

<%= submit_tag "Run Bin Planner" %>
<% end %>

<hr>

<%= link_to "Export CSV",
    export_csv_aisle_sections_path(@aisle),
    class: "btn btn-primary" %>

<h1>Sections</h1>

<div style="margin-bottom: 20px;">
  <%= button_to "UNASSIGN ALL ARTICLES IN AISLE #{@aisle.aisle_num}", 
      bulk_unassign_aisle_path(@aisle), 
      method: :patch,
      data: { confirm: 'WARNING! This will unassign ALL planned articles in this aisle. Are you sure?' },
      style: "background-color:#d9534f;color:white;padding:8px 15px;border:none;border-radius:4px;" %>
</div>

<% @sections.sort_by{ |sec| sec.section_num}.each do |section| %>
  <div class="card col-12" style="border:1px solid #ccc; padding:12px; margin-bottom:16px;">
    <h3>Section <%= link_to section.section_num, section %></h3>

    <p>
      <strong>Section Height:</strong> <%= section.section_height %> mm<br>
      <strong>Used Height:</strong>
      <%= section.levels.sum { |l| l.level_height.to_f }.round(1) %> mm<br>
      <strong>Section Width:</strong> <%= section.section_width %> mm<br>
      <strong>Section Depth:</strong> <%= section.section_depth %> mm
    </p>

    <% section.levels.order(:level_num).each do |level| %>
      <div style="border:1px dashed #999; padding:10px; margin-bottom:10px;">
        <h4>
          Level <%= level.level_num %>
          <span style="color:#555;font-size:0.9em">
            (Height: <%= level.level_height.round(2) %> mm)
          </span>
        </h4>

        <% placements = Placement
             .includes(:article)
             .where(section: section, level: level) %>

        <% if placements.any? %>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f4f4f4">
                <th>Art No</th>
                <th>Name</th>
                <th>DT</th>
                <th>Weight</th>
                <th>Width Used</th>
                
                <th>Length</th>
                <th>PA</th>
                <th>RSSQ</th>
                <th>PALQ</th>
                <th>Badges</th>
                <th>Current Loc</th>
                <th>Unassign</th>
              </tr>
            </thead>

            <tbody>
              <% placements.each do |placement| %>
                <% art = placement.article %>
                <% qualifies_for_mb = art.split_rssq.to_f >= art.palq.to_f * 1.6 %>

                <tr style="border-top:1px solid #ddd">
                  <td><%= link_to art.artno, art %></td>
                  <td><%= art.artname_unicode %></td>
                  <td align="center"><%= art.dt %></td>
                  <td align="right"><%= art.weight_g %></td>

                  <td align="right">
                    <% if placement.badge&.include?('M') && qualifies_for_mb %>
                      <%= (
                          art.ul_width_gross.to_f *
                          (art.split_rssq.to_f / art.palq.to_f).ceil
                        ) %>
                    <% elsif placement.badge&.include?('O') %>
                      <%= art.ul_width_gross %>
                    <% elsif art.level.level_num == "00" %>
                      <%= art.ul_width_gross %>
                    <% else %>
                      <%= art.cp_width %>
                    <% end %>
                  </td>

                  <td align="right"><%= art.effective_height.round(2) %></td>
                  <td><%= art.pa %></td>
                  <td><%= art.split_rssq %></td>
                  <td><%= art.palq %></td>

                  <td align="center">
                    <% if placement.badge.present? %>
                      <% placement.badge.each_char do |badge| %>
                        <% next if ['M','B'].include?(badge) && !qualifies_for_mb && badge != 'O' %>
                        <span
                          style="
                            padding:2px 6px;
                            border-radius:4px;
                            font-weight:bold;
                            color:white;
                            margin-right:3px;
                            background:
                              <%= case badge
                                  when 'M' then '#d9534f'
                                  when 'B' then '#0275d8'
                                  when 'O' then '#6f42c1'
                                  else '#999'
                                end %>;
                          ">
                          <%= badge %>
                        </span>
                      <% end %>
                    <% end %>
                  </td>

                  <td><%= art.slid_h %></td>

                  <td align="center">
                    <%= button_to "Unassign",
                          unassign_article_path(art),
                          method: :patch,
                          data: { confirm: "Unassign article #{art.artno}?" },
                          style: "background-color:#f0ad4e;color:white;padding:4px 8px;border:none;border-radius:4px;" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p style="color:#777">No articles on this level</p>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<%= link_to "New section", new_aisle_section_path(@aisle) %>
